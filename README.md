## PGP in Browser

## PGP Authencation 认证流程

为什么使用 PGP 进行认证, 因为邮箱认证依赖于第三方, 而第三方的邮箱的免费用量不足以支撑认证邮件的发送, 还有一个是第三方会泄露你的踪迹,
而采用 PGP 签名认证就只有网站和你的好友知道你访问了网站, 当然了还有浏览器

为什么不采用帐号+密码的认证方式? 当你看过公司或同事设置的密码后你就会为什么了, 他们的密码如此简单, 只要简单爆破一下就能拿到密码

### 事先准备

1. 网站生成 PGP 密钥对
1. 用户生成 PGP 密钥对
1. 用户和网站交换公钥, 如果网站没有用户公钥则认证失败

### 用户认证

假设服务端登录页面是: http://example.com/login

1. 用户打开网页 http://example.com/login
1. 页面上有一个网站的公钥, 用户需要将这个公钥导入自己 PGP 地址簿中, 在接下来的步骤中会用到
1. 服务端生成一个魔法字符串作为 mid , 同时把生成时间保存为键值对, 然后返回用户这样一段 JSON `{"mid":"magic string for find generate time","auth":"https://example.com/auth","fingerprint":"网站公钥的指纹"}`
   可以通过 `fingerprint` 查找网站公钥, 如果有多个相同指纹的网站公钥则会列出选项框让用户选择
1. 用户填充 JSON 字段 `{"mid":"mid", "fingerprint":"fingerprint"}` 其中 `fingerprint` 为用户公钥指纹
1. 用户使用自己的私钥对 JSON 进行签名并使用网站应用的公钥进行加密
1. 把加密后的内容发回给服务端指定的 `auth` 字段网址 https://example.com/auth , 可以使用 `POST` 和 `GET` 表单发送, 字段是 `content` , 接下来的工作由网站处理
1. 服务端解密内容得到签名内容
1. 使用 mid 查找生成时的时间戳, 如果找不到则返回 mid 已过期的错误
1. 验证 mid 生成时的时间戳与当前服务器时间戳的差值是否超过了 60s , 如果超过了 60s 则认证失败 (这个过期时间由服务端自行决定, 推荐 60s)
1. 服务端根据指纹查找符合的公钥(可能会找到多个)
1. 使用公钥匹配签名是否正确, 如果匹配成功的个数不为 `1` 则认证失败, 返回用户未被邀请的错误
1. 网站应用可以设置 `cookie` 或者返回 `token` 给用户保存使用
